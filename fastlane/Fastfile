default_platform(:mac)

platform :mac do
  desc "Build the app"
  lane :build do
    tuist_generate

    build_mac_app(
      workspace: "Allkdic.xcworkspace",
      scheme: "Allkdic",
      configuration: "Release",
      clean: true,
      output_directory: "./build",
      output_name: "Allkdic.app",
      export_method: "app-store"
    )
  end

  desc "Build and upload to App Store"
  lane :release do
    tuist_generate

    match(
      type: "appstore",
      platform: "macos",
      api_key: get_api_key,
      additional_cert_types: ["mac_installer_distribution"]
    )

    build_mac_app(
      workspace: "Allkdic.xcworkspace",
      scheme: "Allkdic",
      configuration: "Release",
      clean: true,
      output_directory: "./build",
      export_method: "app-store"
    )

    upload_to_app_store(
      api_key: get_api_key,
      skip_metadata: false,
      skip_screenshots: false,
      precheck_include_in_app_purchases: false,
      force: true
    )
  end

  desc "Update App Store metadata"
  lane :metadata do
    upload_to_app_store(
      api_key: get_api_key,
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true
    )
  end

  # Download metadata:
  # bundle exec fastlane deliver download_metadata --api_key_path ./fastlane/api_key.json --platform osx --use_live_version true
  #
  # Download screenshots:
  # bundle exec fastlane deliver download_screenshots --api_key_path ./fastlane/api_key.json --platform osx --use_live_version true

  desc "Sync certificates and profiles"
  lane :certs do
    match(
      type: "appstore",
      platform: "macos",
      api_key: get_api_key,
      additional_cert_types: ["mac_installer_distribution"]
    )
  end

  desc "Bump version and build number"
  lane :bump do |options|
    version = options[:version]
    UI.user_error!("Usage: fastlane bump version:X.Y.Z") unless version

    plist_path = "Allkdic/Allkdic-Info.plist"

    # Set version
    set_info_plist_value(
      path: plist_path,
      key: "CFBundleShortVersionString",
      value: version
    )

    # Increment build number
    current_build = get_info_plist_value(
      path: plist_path,
      key: "CFBundleVersion"
    ).to_i
    new_build = current_build + 1

    set_info_plist_value(
      path: plist_path,
      key: "CFBundleVersion",
      value: new_build.to_s
    )

    UI.success("Version: #{version}, Build: #{current_build} â†’ #{new_build}")

    git_commit(
      path: plist_path,
      message: "Bump version to #{version} (#{new_build})"
    )
  end
end

def tuist_generate
  sh "cd .. && tuist generate --no-open"
end

def get_api_key
  api_key_path = File.join(__dir__, "api_key.json")
  api_key_json = JSON.parse(File.read(api_key_path))
  app_store_connect_api_key(
    key_id: api_key_json["key_id"],
    issuer_id: api_key_json["issuer_id"],
    key_content: api_key_json["key"],
    in_house: api_key_json["in_house"]
  )
end
